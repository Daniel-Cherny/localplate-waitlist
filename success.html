<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to LocalPlate! - You're on the List</title>
    <meta name="description" content="Success! You're on the LocalPlate waitlist. Get ready for verified nutrition data from your favorite local restaurants.">
    <meta name="color-scheme" content="light dark">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%2310b981'/%3E%3C/svg%3E">
    
    <!-- Fonts - Premium Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'; this.onload=null;">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    </noscript>
    
    <!-- Apply saved theme early to avoid flash -->
    <script>
        (function() {
            try {
                const storedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            } catch (error) {
                // Ignore theme hydration errors
            }
        })();
    </script>

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css?v=09262025p">
    
    <!-- Inline styles removed; now consolidated in styles.css for consistency -->
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white antialiased overflow-x-hidden">
    
    <!-- Noise Texture Overlay -->
    <div class="noise-overlay"></div>
    
    <!-- Navigation -->
    <nav class="fixed top-0 w-full bg-transparent backdrop-blur-sm z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <a href="index.html" class="flex items-center space-x-3 no-underline">
                    <svg class="w-8 h-8 logo-spin" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="24" cy="24" r="20" fill="url(#gradient-plate)"/>
                        <circle cx="14" cy="20" r="3" fill="#ef4444" class="animate-pulse-slow"/>
                        <circle cx="24" cy="18" r="3" fill="#f59e0b" class="animate-pulse-slow animation-delay-100"/>
                        <circle cx="34" cy="20" r="3" fill="#84cc16" class="animate-pulse-slow animation-delay-200"/>
                        <rect x="22" y="28" width="4" height="12" rx="2" fill="#6b7280"/>
                        <defs>
                            <linearGradient id="gradient-plate" x1="0" y1="0" x2="48" y2="48">
                                <stop stop-color="#10b981"/>
                                <stop offset="1" stop-color="#059669"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span class="text-xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-500 bg-clip-text text-transparent">
                        LocalPlate
                    </span>
                </a>
                
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-all hover:scale-110" aria-label="Toggle dark mode">
                    <svg class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414z"/>
                    </svg>
                    <svg class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>
                
            </div>
        </div>
    </nav>
    
    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none z-50" style="pointer-events: none !important;"></canvas>
    
    <!-- Hero Section with Ken Burns Effect -->
    <section class="relative min-h-screen flex items-center justify-center pt-16 overflow-hidden">
        <!-- Background Image with Ken Burns -->
        <div class="absolute inset-0 ken-burns-container">
            <div class="ken-burns-image"></div>
        </div>
        
        <!-- Gradient Overlay -->
        <div class="absolute inset-0 bg-gradient-to-b from-white/80 via-white/70 to-white/90 dark:from-gray-900/80 dark:via-gray-900/70 dark:to-gray-900/90"></div>
        
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="space-y-14">
            
            <!-- Success Intro -->
                <div class="max-w-3xl mx-auto text-center space-y-6 animate-fade-in-up">
                
                <!-- Success Icon -->
                <div class="success-icon-wrapper">
                    <div class="w-20 h-20 bg-gradient-to-br from-emerald-400 via-emerald-500 to-teal-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-success-pulse relative z-10 shadow-2xl hover:shadow-emerald-500/25 transition-all hover:scale-110 group">
                        <svg class="w-10 h-10 text-white group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Heading -->
                <h1 class="font-serif text-5xl sm:text-6xl lg:text-6xl font-bold mb-3 text-gray-900 dark:text-white animate-fade-in-up animation-delay-100">
                    Congratulations! You're in.
                </h1>

                <!-- Subheading -->
                <p class="text-xl text-gray-600 dark:text-gray-300 mb-8 animate-fade-in-up animation-delay-200">
                    Welcome to the Founding Cohort, <span id="user-name" class="font-medium text-gray-900 dark:text-white">friend</span>!
                </p>
                </div>

                <div class="space-y-12 max-w-5xl mx-auto">
                    <!-- Movement Identity Card -->
                    <div class="form-card tier-status-card reveal-on-scroll animation-delay-250">
                        <div class="space-y-4">
                            <span id="waitlist-tier-name" class="tier-status-badge">Early Insider</span>
                            <p id="waitlist-tier-subtitle" class="tier-status-subtitle">You're already ahead of the curve.</p>
                        </div>
                    </div>

                    <!-- Referral Section -->
                    <div class="form-card reveal-on-scroll hover:shadow-2xl transition-shadow">
                        <div class="space-y-4">
                            <h2 class="font-serif text-3xl font-bold bg-gradient-to-r from-emerald-400 via-emerald-500 to-teal-500 bg-clip-text text-transparent text-center">Share the Magic</h2>
                            <p class="text-gray-600 dark:text-gray-400 text-center">
                                Your friends skip the line. You unlock rewards. Everyone wins.
                            </p>

                            <!-- Referral Link -->
                            <div class="flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="referral-link" 
                                readonly 
                                value="https://localplate.com/?ref=ABC123"
                                class="flex-1 bg-white/90 dark:bg-gray-800/90 px-3 py-2 rounded-lg text-sm text-gray-700 dark:text-gray-300 focus:outline-none"
                            >
                            <button 
                                onclick="copyLink(event)" 
                                class="btn-primary group hover:scale-105 transition-all"
                            >
                                <span>Copy</span>
                                <svg class="w-4 h-4 ml-2 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Share Buttons -->
                        <div class="flex flex-wrap justify-center gap-8 w-full max-w-3xl mx-auto" role="group" aria-label="Share your referral link">
                        <!-- X/Twitter -->
                        <a id="share-x"
                            href="#" target="_blank" rel="noopener noreferrer"
                            class="btn-secondary flex items-center justify-center min-w-11 min-h-11 p-3 hover:scale-105 transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-gray-900"
                            aria-label="Share on X"
                            title="Share on X"
                        >
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>

                        <!-- Facebook -->
                        <a id="share-facebook"
                            href="#" target="_blank" rel="noopener noreferrer"
                            class="btn-secondary flex items-center justify-center min-w-11 min-h-11 p-3 hover:scale-105 transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-gray-900"
                            aria-label="Share on Facebook"
                            title="Share on Facebook"
                        >
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>

                        <!-- LinkedIn -->
                        <a id="share-linkedin"
                            href="#" target="_blank" rel="noopener noreferrer"
                            class="btn-secondary flex items-center justify-center min-w-11 min-h-11 p-3 hover:scale-105 transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-gray-900"
                            aria-label="Share on LinkedIn"
                            title="Share on LinkedIn"
                        >
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                            </svg>
                        </a>

                        <!-- WhatsApp -->
                        <a id="share-whatsapp"
                            href="#" target="_blank" rel="noopener noreferrer"
                            class="btn-secondary flex items-center justify-center min-w-11 min-h-11 p-3 hover:scale-105 transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-gray-900"
                            aria-label="Share on WhatsApp"
                            title="Share on WhatsApp"
                        >
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.488"/>
                            </svg>
                        </a>

                        <!-- Bluesky -->
                        <a id="share-bluesky"
                            href="#" target="_blank" rel="noopener noreferrer"
                            class="btn-secondary flex items-center justify-center min-w-11 min-h-11 p-3 hover:scale-105 transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-gray-900"
                            aria-label="Share on Bluesky"
                            title="Share on Bluesky"
                        >
                            <!-- Bluesky butterfly logo -->
                            <svg class="w-5 h-5" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false">
                                <path d="M3.468 1.948C5.303 3.325 7.276 6.118 8 7.616c.725-1.498 2.698-4.29 4.532-5.668C13.855.955 16 .186 16 2.632c0 .489-.28 4.105-.444 4.692-.572 2.04-2.653 2.561-4.504 2.246 3.236.551 4.06 2.375 2.281 4.2-3.376 3.464-4.852-.87-5.23-1.98-.07-.204-.103-.3-.103-.218 0-.081-.033.014-.102.218-.379 1.11-1.855 5.444-5.231 1.98-1.778-1.825-.955-3.65 2.28-4.2-1.85.315-3.932-.205-4.503-2.246C.28 6.737 0 3.12 0 2.632 0 .186 2.145.955 3.468 1.948"/>
                            </svg>
                        </a>
                    </div>
                        </div>
                    </div>

                    <!-- Progressive Profile (Optional) -->
                    <div class="form-card reveal-on-scroll" id="profile-card">
                        <div class="space-y-5">
                            <div class="text-center space-y-2">
                                <h3 class="font-serif text-2xl font-semibold">Want to personalize your invite?</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Totally optional‚Äîshare a few details so we can tailor launch updates.</p>
                            </div>
                            <form id="profile-form" class="space-y-4" novalidate>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="profile-first-name" class="form-label">First Name</label>
                                        <input type="text" id="profile-first-name" name="firstName" autocomplete="given-name" placeholder="John" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-phone" class="form-label">Phone</label>
                                        <input type="tel" id="profile-phone" name="phone" autocomplete="tel" placeholder="(555) 123-4567" class="form-input">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="profile-zip" class="form-label">ZIP Code</label>
                                        <input type="text" id="profile-zip" name="zip" inputmode="numeric" pattern="[0-9]{5}" maxlength="5" placeholder="94102" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-hear" class="form-label">How did you hear about us?</label>
                                        <select id="profile-hear" name="referralSource" class="form-input">
                                            <option value="">Select one...</option>
                                            <option value="flyer">Flyer / QR code</option>
                                            <option value="friend">Friend or family</option>
                                            <option value="social">Social media</option>
                                            <option value="event">Fitness or wellness event</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <button type="submit" id="profile-submit" class="btn-secondary w-full sm:w-auto">
                                        <span id="profile-submit-text">Save details</span>
                                        <svg id="profile-submit-loader" class="hidden animate-spin h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </button>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">We‚Äôll never share your info. Skip it now and finish later any time.</p>
                                    <div id="profile-status" class="hidden text-sm"></div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Ambassador Reward Card (visible once cohort fills) -->
                    <div id="ambassador-card" class="form-card ambassador-card hidden reveal-on-scroll animation-delay-300">
                    <div class="ambassador-header">
                        <span class="ambassador-badge">Ambassador Reward</span>
                        <span class="ambassador-pill">Three free months</span>
                    </div>
                    <p id="ambassador-message" class="ambassador-message">
                        Once the founding cohort fills, five verified referrals lock three free months and a personal invite for one friend.
                    </p>
                    <button type="button" class="btn-secondary w-full sm:w-auto" onclick="copyLink()">
                        Copy your invite link
                    </button>
                    </div>

                    <!-- Referral Progress - Enhanced Premium Design -->
                    <div class="form-card reveal-on-scroll">
                        <div class="space-y-6">
                            <!-- Header Section -->
                            <div class="text-center space-y-6">
                                <h3 class="font-serif text-3xl font-bold text-center">
                                    <span class="bg-gradient-to-r from-emerald-400 via-emerald-500 to-teal-500 bg-clip-text text-transparent animate-gradient-x">
                                        Unlock the Perks
                                    </span>
                                </h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 max-w-md mx-auto">
                                    Each friend you bring multiplies your rewards. Track your journey to premium perks.
                                </p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                                <!-- Tier 1 - Catalyst -->
                                <div id="tier-1" class="tier-card-premium group relative">
                                    <!-- Card Background & Border -->
                                    <div class="tier-card-body relative rounded-2xl p-6 border-2 border-emerald-200 dark:border-emerald-800 transition-all duration-300 group-hover:border-emerald-400 dark:group-hover:border-emerald-600 group-hover:shadow-emerald-200/50 dark:group-hover:shadow-emerald-900/50">
                                        <!-- Status Badge -->
                                        <div class="tier-status-indicator absolute -top-3 -right-3 w-8 h-8 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 shadow-lg">
                                            <span class="text-white text-xs font-bold">1</span>
                                        </div>

                                        <!-- Icon Container with Animation -->
                                        <div class="tier-icon-premium relative mx-auto mb-3 w-20 h-20">
                                            <!-- Removed transparent overlay for cleaner look -->
                                            <div class="relative w-full h-full bg-gradient-to-br from-emerald-400 to-teal-500 rounded-full flex items-center justify-center shadow-xl group-hover:scale-110 transition-transform duration-300">
                                                <!-- Leaf/Smoothie Icon -->
                                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20 7c0 2.21-1.79 4-4 4S12 9.21 12 7c0-2.21 1.79-4 4-4s4 1.79 4 4zM12 7c0 2.21-1.79 4-4 4S4 9.21 4 7c0-2.21 1.79-4 4-4s4 1.79 4 4z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 11v10M8 21h8"/>
                                                </svg>
                                            </div>
                                        </div>

                                        <!-- Content -->
                                        <div class="text-center">
                                            <h4 class="tier-title text-lg font-bold text-white mb-3">Catalyst</h4>

                                            <!-- Reward Display -->
                                            <div class="tier-reward mb-3 py-2 px-4 bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 rounded-lg">
                                                <div class="text-2xl font-bold text-white">50% OFF</div>
                                                <div class="text-xs text-white/80">First Month</div>
                                            </div>

                                            <p class="tier-description text-sm text-white/90 mb-3 leading-relaxed">
                                                1 friend away
                                            </p>

                                            <!-- Progress Section -->
                                            <div class="tier-progress-section">
                                                <div class="tier-progress-header">
                                                    <span class="tier-progress-label text-white/70">Progress</span>
                                                    <span id="progress-count-1" class="tier-progress-count text-white">0/1</span>
                                                </div>
                                                <div id="progress-bar-1" class="tier-progress-bar">
                                                    <div class="progress-fill" style="width: 0%"></div>
                                                </div>
                                                <p id="progress-label-1" class="tier-progress-caption text-xs text-white/70 mt-2 font-medium">Ready to unlock</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tier 2 - VIP -->
                                <div id="tier-2" class="tier-card-premium group relative">
                                    <div class="tier-card-body relative rounded-2xl p-6 border-2 border-gray-200 dark:border-gray-700 transition-all duration-300 group-hover:border-amber-400 dark:group-hover:border-amber-600">
                                        <!-- Status Badge -->
                                        <div class="tier-status-indicator absolute -top-3 -right-3 w-8 h-8 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg">
                                            <span class="text-white text-xs font-bold">2</span>
                                        </div>

                                        <!-- Icon Container -->
                                        <div class="tier-icon-premium relative mx-auto mb-3 w-20 h-20">
                                            <!-- Removed transparent overlay for cleaner look -->
                                            <div class="relative w-full h-full bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center shadow-xl group-hover:scale-110 transition-transform duration-300">
                                                <!-- Trophy Icon -->
                                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15l-2 5h4l-2-5zM7 7h10l1.5 4.5a2 2 0 01-1.9 2.5H7.4a2 2 0 01-1.9-2.5L7 7zM5 7V4a1 1 0 011-1h12a1 1 0 011 1v3"/>
                                                </svg>
                                            </div>
                                        </div>

                                        <!-- Content -->
                                        <div class="text-center">
                                            <h4 class="tier-title text-lg font-bold text-white mb-3">VIP</h4>

                                            <!-- Reward Display -->
                                            <div class="tier-reward mb-3 py-2 px-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-lg">
                                                <div class="text-2xl font-bold text-white">100% OFF</div>
                                                <div class="text-xs text-white/80">First Month Free</div>
                                            </div>

                                            <p class="tier-description text-sm text-white/90 mb-3 leading-relaxed">
                                                3 friends to unlock
                                            </p>

                                            <!-- Progress Section -->
                                            <div class="tier-progress-section">
                                                <div class="tier-progress-header">
                                                    <span class="tier-progress-label text-white/70">Progress</span>
                                                    <span id="progress-count-2" class="tier-progress-count text-white">0/3</span>
                                                </div>
                                                <div id="progress-bar-2" class="tier-progress-bar">
                                                    <div class="progress-fill" style="width: 0%"></div>
                                                </div>
                                                <p id="progress-label-2" class="tier-progress-caption text-xs text-white/70 mt-2 font-medium">3 referrals needed</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tier 3 - GOAT -->
                                <div id="tier-3" class="tier-card-premium group relative">
                                    <div class="tier-card-body relative rounded-2xl p-6 border-2 border-gray-200 dark:border-gray-700 transition-all duration-300 group-hover:border-rose-400 dark:group-hover:border-rose-600">
                                        <!-- Status Badge -->
                                        <div class="tier-status-indicator absolute -top-3 -right-3 w-8 h-8 bg-gradient-to-br from-rose-400 to-purple-500 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg">
                                            <span class="text-white text-xs font-bold">3</span>
                                        </div>

                                        <!-- Icon Container with Glow Effect -->
                                        <div class="tier-icon-premium relative mx-auto mb-3 w-20 h-20">
                                            <!-- Removed transparent overlays for cleaner look -->
                                            <div class="relative w-full h-full bg-gradient-to-br from-rose-400 via-pink-500 to-purple-600 rounded-full flex items-center justify-center shadow-xl group-hover:scale-110 transition-transform duration-300">
                                                <!-- Crown/Star Icon -->
                                                <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm2.86-2h8.28l.57-4L14 8l-2-3-2 3-2.71 2L7.86 14z"/>
                                                </svg>
                                            </div>
                                        </div>

                                        <!-- Content -->
                                        <div class="text-center">
                                            <h4 class="tier-title text-lg font-bold text-white mb-3">GOAT üêê</h4>

                                            <!-- Reward Display with Glow -->
                                            <div class="tier-reward mb-3 py-2 px-4 bg-gradient-to-r from-rose-50 via-pink-50 to-purple-50 dark:from-rose-900/20 dark:via-pink-900/20 dark:to-purple-900/20 rounded-lg relative overflow-hidden">
                                                <div class="absolute inset-0 bg-gradient-to-r from-rose-400/10 to-purple-400/10 animate-shimmer"></div>
                                                <div class="relative text-2xl font-bold text-white">200% OFF</div>
                                                <div class="relative text-xs text-white/80">Two Months Free</div>
                                            </div>

                                            <p class="tier-description text-sm text-white/90 mb-3 leading-relaxed">
                                                5 friends to unlock
                                            </p>

                                            <!-- Progress Section -->
                                            <div class="tier-progress-section">
                                                <div class="tier-progress-header">
                                                    <span class="tier-progress-label text-white/70">Progress</span>
                                                    <span id="progress-count-3" class="tier-progress-count text-white">0/5</span>
                                                </div>
                                                <div id="progress-bar-3" class="tier-progress-bar">
                                                    <div class="progress-fill" style="width: 0%"></div>
                                                </div>
                                                <p id="progress-label-3" class="tier-progress-caption text-xs text-white/70 mt-2 font-medium">5 referrals needed</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- What's Next -->
                    <div class="form-card reveal-on-scroll hover:shadow-2xl transition-shadow">
                        <div class="space-y-4">
                            <h3 class="font-serif text-3xl font-bold text-center bg-gradient-to-r from-emerald-400 via-emerald-500 to-teal-500 bg-clip-text text-transparent">What Happens Next?</h3>
                            <div class="text-left space-y-3 text-sm text-gray-600 dark:text-gray-400">
                                <div class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Expect an email to track your referrals within 48 hours</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Watch for weekly nudges showing progress to the next milestone</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Follow Us -->
                    <div class="follow-us-section text-center reveal-on-scroll">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Follow us for updates</p>
                        <div class="flex justify-center items-center space-x-6">
                            <a href="https://x.com/localplateapp" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-emerald-600 dark:text-gray-400 dark:hover:text-emerald-400 transition-all hover:scale-110 hover:shadow-lg rounded-lg p-2">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                            </a>
                            <a href="#" class="text-gray-500 hover:text-emerald-600 dark:text-gray-400 dark:hover:text-emerald-400 transition-all hover:scale-110 hover:shadow-lg rounded-lg p-2">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1112.324 0 6.162 6.162 0 01-12.324 0zM12 16a4 4 0 110-8 4 4 0 010 8zm4.965-10.405a1.44 1.44 0 112.881.001 1.44 1.44 0 01-2.881-.001z"/>
                                </svg>
                            </a>
                            <a href="#" class="text-gray-500 hover:text-emerald-600 dark:text-gray-400 dark:hover:text-emerald-400 transition-all hover:scale-110 hover:shadow-lg rounded-lg p-2">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                            </a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>
    
    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 py-12 sm:py-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-12">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="24" cy="24" r="20" fill="url(#gradient-plate-footer)"/>
                        <circle cx="14" cy="20" r="3" fill="#ef4444"/>
                        <circle cx="24" cy="18" r="3" fill="#f59e0b"/>
                        <circle cx="34" cy="20" r="3" fill="#84cc16"/>
                        <rect x="22" y="28" width="4" height="12" rx="2" fill="#6b7280"/>
                        <defs>
                            <linearGradient id="gradient-plate-footer" x1="0" y1="0" x2="48" y2="48">
                                <stop stop-color="#10b981"/>
                                <stop offset="1" stop-color="#059669"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span class="text-lg font-semibold text-gray-900 dark:text-white">LocalPlate</span>
                </div>
                
                <!-- Copyright -->
                <p class="text-sm text-gray-500 dark:text-gray-500 text-center md:text-left" style="white-space: nowrap;">
                    ¬© 2025 LocalPlate. All rights reserved.
                </p>
            </div>
        </div>
    </footer>
    
    <!-- Copy Toast -->
    <div id="copy-toast" class="hidden fixed bottom-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg animate-slide-up">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span>Link copied to clipboard!</span>
        </div>
    </div>
    
    <script>
        const DEBUG = new URLSearchParams(location.search).has('debug');
        const SUCCESS_EMAIL_KEY = 'waitlist_email';
        const SUCCESS_REFERRAL_KEY = 'waitlist_referral_code';
        const SUCCESS_CONTEXT_KEY = 'waitlist_lead_context';
        const PROFILE_STORAGE_KEY = 'waitlist_profile_data';

        const leadContext = loadLeadContext();
        const cachedEmail = sessionStorage.getItem(SUCCESS_EMAIL_KEY) || '';
        const cachedReferralCode = sessionStorage.getItem(SUCCESS_REFERRAL_KEY) || '';

        function trace(...args) {
            if (DEBUG) {
                console.log('[success]', ...args);
            }
        }

        function loadLeadContext() {
            try {
                const raw = sessionStorage.getItem(SUCCESS_CONTEXT_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (error) {
                trace('loadLeadContext failed', error.message);
                return {};
            }
        }

        function sanitizeMetadata(metadata = {}) {
            return Object.fromEntries(
                Object.entries(metadata).filter(([, value]) => value !== undefined && value !== null && value !== '')
            );
        }

        async function logTelemetry(eventType, payload = {}) {
            try {
                if (!eventType) return;
                const supabase = window.getSupabaseClient();
                const metadata = sanitizeMetadata({
                    ...payload,
                    landing_url: leadContext?.landing_url,
                    referrer: leadContext?.referrer,
                });
                const utms = leadContext?.utms || {};
                await supabase.from('waitlist_events').insert([
                    {
                        event_type: eventType,
                        occurred_at: new Date().toISOString(),
                        metadata,
                        email: cachedEmail || null,
                        referral_code: cachedReferralCode || null,
                        utm_source: utms.utm_source || null,
                        utm_medium: utms.utm_medium || null,
                        utm_campaign: utms.utm_campaign || null,
                    }
                ]);
            } catch (error) {
                trace('logTelemetry failed', error.message);
            }
        }

        function trackEvent(eventName, eventData = {}) {
            if (typeof gtag === 'function') {
                gtag('event', eventName, eventData);
            }
        }

        function loadProfileFromSession() {
            try {
                const raw = sessionStorage.getItem(PROFILE_STORAGE_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (error) {
                trace('loadProfileFromSession failed', error.message);
                return {};
            }
        }

        function persistProfileToSession(profile) {
            try {
                sessionStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile || {}));
            } catch (error) {
                trace('persistProfileToSession failed', error.message);
            }
        }

        let profileState = Object.assign({
            firstName: '',
            phone: '',
            zip: '',
            referralSource: ''
        }, loadProfileFromSession() || {});

        const profileForm = document.getElementById('profile-form');
        const profileFirstNameInput = document.getElementById('profile-first-name');
        const profilePhoneInput = document.getElementById('profile-phone');
        const profileZipInput = document.getElementById('profile-zip');
        const profileHearInput = document.getElementById('profile-hear');
        const profileStatus = document.getElementById('profile-status');
        const profileSubmitButton = document.getElementById('profile-submit');
        const profileSubmitText = document.getElementById('profile-submit-text');
        const profileSubmitLoader = document.getElementById('profile-submit-loader');

        function updateGreetingName(name) {
            const displayName = name && name.trim() ? name.trim() : 'friend';
            const el = document.getElementById('user-name');
            if (el) {
                el.textContent = displayName;
            }
        }

        function hydrateProfileForm() {
            if (!profileForm) return;
            if (profileFirstNameInput) {
                profileFirstNameInput.value = profileState.firstName || '';
            }
            if (profilePhoneInput) {
                profilePhoneInput.value = profileState.phone ? formatPhone(profileState.phone) : '';
            }
            if (profileZipInput) {
                profileZipInput.value = profileState.zip || '';
            }
            if (profileHearInput) {
                profileHearInput.value = profileState.referralSource || '';
            }
        }

        function clearProfileStatus() {
            if (!profileStatus) return;
            profileStatus.className = 'hidden text-sm';
            profileStatus.textContent = '';
        }

        function setProfileStatus(message, type = 'success') {
            if (!profileStatus) return;
            profileStatus.textContent = message;
            profileStatus.classList.remove('hidden', 'text-emerald-600', 'text-red-500', 'text-red-600');
            profileStatus.classList.add(type === 'error' ? 'text-red-600' : 'text-emerald-600');
        }

        function setProfileLoading(isLoading) {
            if (!profileSubmitButton) return;
            profileSubmitButton.disabled = isLoading;
            if (profileSubmitText) {
                profileSubmitText.classList.toggle('hidden', isLoading);
            }
            if (profileSubmitLoader) {
                profileSubmitLoader.classList.toggle('hidden', !isLoading);
            }
        }

        function updateProfileState(patch = {}) {
            const normalized = Object.assign({}, patch);
            if (typeof normalized.firstName === 'string') {
                normalized.firstName = normalized.firstName.trim();
            }
            if (typeof normalized.phone === 'string') {
                normalized.phone = normalized.phone.replace(/\D/g, '');
            }
            if (typeof normalized.zip === 'string') {
                normalized.zip = normalized.zip.replace(/\D/g, '');
            }
            profileState = Object.assign({}, profileState, normalized);
            persistProfileToSession(profileState);
            hydrateProfileForm();
            updateGreetingName(profileState.firstName);
        }

        function mergeRemoteProfile(remote = {}) {
            const patch = {};
            if (remote.first_name && remote.first_name !== profileState.firstName) {
                patch.firstName = remote.first_name;
            }
            if (remote.phone && remote.phone !== profileState.phone) {
                patch.phone = remote.phone.replace(/\D/g, '');
            }
            if (remote.zipcode && remote.zipcode !== profileState.zip) {
                patch.zip = remote.zipcode;
            }
            if (remote.referral_source && remote.referral_source !== profileState.referralSource) {
                patch.referralSource = remote.referral_source;
            }
            if (Object.keys(patch).length) {
                updateProfileState(patch);
            }
        }

        hydrateProfileForm();
        updateGreetingName(profileState.firstName);

        profilePhoneInput?.addEventListener('input', (event) => {
            clearProfileStatus();
            const digits = event.target.value.replace(/\D/g, '').slice(0, 10);
            event.target.value = formatPhone(digits);
        });

        profileZipInput?.addEventListener('input', (event) => {
            clearProfileStatus();
            event.target.value = event.target.value.replace(/\D/g, '').slice(0, 5);
        });

        profileFirstNameInput?.addEventListener('input', clearProfileStatus);
        profileHearInput?.addEventListener('change', clearProfileStatus);

        profileForm?.addEventListener('submit', handleProfileSubmit);

        async function handleProfileSubmit(event) {
            event.preventDefault();
            clearProfileStatus();

            if (!cachedEmail || !cachedReferralCode) {
                setProfileStatus('Session expired. Please rejoin the waitlist to update details.', 'error');
                return;
            }

            const firstName = (profileFirstNameInput?.value || '').trim();
            const phoneDigits = (profilePhoneInput?.value || '').replace(/\D/g, '').slice(0, 10);
            const zipDigits = (profileZipInput?.value || '').replace(/\D/g, '').slice(0, 5);
            const referralSource = (profileHearInput?.value || '').trim();

            if (!firstName && !phoneDigits && !zipDigits && !referralSource) {
                setProfileStatus('Add at least one detail to save.', 'error');
                return;
            }

            if (phoneDigits && phoneDigits.length < 10) {
                setProfileStatus('Phone number needs 10 digits.', 'error');
                return;
            }

            if (profileZipInput && profileZipInput.value && zipDigits.length !== 5) {
                setProfileStatus('ZIP should be 5 digits.', 'error');
                return;
            }

            const payload = {
                p_email: cachedEmail,
                p_referral_code: cachedReferralCode
            };

            const fields = [];
            if (firstName && firstName !== profileState.firstName) {
                payload.p_first_name = firstName;
                fields.push('first_name');
            }
            if (phoneDigits && phoneDigits !== profileState.phone) {
                payload.p_phone = phoneDigits;
                fields.push('phone');
            }
            if (zipDigits && zipDigits !== profileState.zip) {
                payload.p_zipcode = zipDigits;
                fields.push('zipcode');
            }
            if (referralSource && referralSource !== profileState.referralSource) {
                payload.p_referral_source = referralSource;
                fields.push('referral_source');
            }

            if (fields.length === 0) {
                setProfileStatus('You\'re already up to date.', 'error');
                return;
            }

            setProfileLoading(true);
            try {
                const supabase = window.getSupabaseClient();
                const { data, error } = await supabase.rpc('update_waitlist_profile', payload);

                if (error || data?.success === false) {
                    const message = data?.message || error?.message || 'Unable to save details. Please try again.';
                    trace('profile update error', message);
                    setProfileStatus(message, 'error');
                    return;
                }

                const patch = {};
                if (payload.p_first_name) patch.firstName = payload.p_first_name;
                if (payload.p_phone) patch.phone = payload.p_phone;
                if (payload.p_zipcode) patch.zip = payload.p_zipcode;
                if (payload.p_referral_source) patch.referralSource = payload.p_referral_source;
                updateProfileState(patch);

                setProfileStatus('Details saved! Thanks for sharing.', 'success');
                logTelemetry('profile_updated', { fields });
                trackEvent('profile_updated', { fields });
            } catch (err) {
                trace('profile update exception', err.message);
                setProfileStatus('Something went wrong. Please try again.', 'error');
            } finally {
                setProfileLoading(false);
            }
        }

        function formatPhone(value) {
            if (!value) return '';
            const digits = value.replace(/\D/g, '').slice(0, 10);
            if (digits.length <= 3) return digits;
            if (digits.length <= 6) return `${digits.slice(0, 3)}-${digits.slice(3)}`;
            return `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6)}`;
        }

        // Real-time gamification system
        class ReferralGamificationSystem {
            constructor() {
                this.userEmail = null;
                this.userReferralCode = null;
                this.userReferralCount = 0;
                this.userWaitlistPosition = null;
                this.totalCommunitySize = 0;
                this.userPercentile = null;
                this.supabaseClient = null;
                this.realTimeSubscription = null;

                this.waitlistCap = 500;
                // Single movement declaration - no tiers, just identity reinforcement
                this.movementCard = {
                    slug: 'revolution',
                    title: 'You\'re Part of the Revolution',
                    subtitle: "You're joining millions who believe that we have a right to know what we put in our bodies.\n\nYour health matters.\nYour food matters.\nYour community matters.\n\nTogether, we're making healthy eating as natural as breathing.",
                    gradient: 'linear-gradient(90deg,#059669,#0ea5e9)'
                };

                this.tiers = [
                    {
                        id: 1,
                        referralsRequired: 1,
                        title: "Catalyst",
                        reward: "50% off your first month",
                        description: "Bring 1 health-conscious friend and score 50% off your first month."
                    },
                    {
                        id: 2,
                        referralsRequired: 3,
                        title: "VIP",
                        reward: "100% off your first month",
                        description: "Refer 3 health-conscious friends and take 100% off your first month."
                    },
                    {
                        id: 3,
                        referralsRequired: 5,
                        title: "GOAT üêê",
                        reward: "2 months free",
                        description: "Bring 5 health-conscious friends and enjoy 2 full months on us."
                    }
                ];

                this.ambassadorRewardActive = false;
            }
            
            async init() {
                try {
                    // Initialize Supabase client
                    this.supabaseClient = window.getSupabaseClient();
                    
                    // Get user data from session
                    this.userEmail = sessionStorage.getItem('waitlist_email');
                    this.userReferralCode = sessionStorage.getItem('waitlist_referral_code');
                    
                    if (!this.userEmail || !this.userReferralCode) {
                        throw new Error('User data not found');
                    }
                    
                    // Load initial data
                    await this.loadUserStats();
                    await this.loadCommunityStats();
                    
                    // Set up real-time subscriptions
                    this.setupRealTimeUpdates();
                    
                    // Start periodic updates for community stats
                    this.startPeriodicUpdates();
                    
                    console.log('[GAMIFICATION] System initialized successfully');
                } catch (error) {
                    console.error('[GAMIFICATION] Initialization failed:', error);
                    this.showError('Failed to load referral data. Some features may not work.');
                }
            }
            
            async loadUserStats() {
                try {
                    // Get user's referral count and position
                    const { data, error } = await this.supabaseClient
                        .rpc('get_user_referral_stats', { 
                            user_referral_code: this.userReferralCode 
                        });
                    
                    if (error) {
                        console.error('Failed to load user stats:', error);
                        return;
                    }
                    
                    if (data) {
                        if (data.profile && typeof data.profile === 'object') {
                            mergeRemoteProfile(data.profile);
                        } else {
                            mergeRemoteProfile(data);
                        }
                        this.userReferralCount = data.referral_count || 0;
                        this.userWaitlistPosition = data.waitlist_position || null;
                        
                        this.updateReferralDisplay();
                        this.updateTierProgress();
                        this.refreshStanding();
                    }
                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }
            
            async loadCommunityStats() {
                try {
                    // Get total community size and daily referrals
                    const { data, error } = await this.supabaseClient
                        .rpc('get_community_stats');
                    
                    if (error) {
                        console.error('Failed to load community stats:', error);
                        return;
                    }
                    
                    if (data) {
                        this.totalCommunitySize = data.total_members || 0;
                        this.dailyReferrals = data.daily_referrals || 0;
                        
                        this.updateCommunityDisplay();
                        this.refreshStanding();
                    this.evaluateAmbassadorReward();
                    }
                } catch (error) {
                    console.error('Error loading community stats:', error);
                }
            }
            
            setupRealTimeUpdates() {
                try {
                    // Subscribe to referral updates for this user
                    this.realTimeSubscription = this.supabaseClient
                        .channel('referral-updates')
                        .on(
                            'postgres_changes',
                            {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'waitlist',
                                filter: `referred_by=eq.${this.userReferralCode}`
                            },
                            (payload) => {
                                console.log('[REAL-TIME] New referral detected:', payload);
                                this.handleNewReferral(payload.new);
                            }
                        )
                        .subscribe();
                    
                    console.log('[REAL-TIME] Subscription active');
                } catch (error) {
                    console.error('Failed to setup real-time updates:', error);
                }
            }
            
            handleNewReferral(newReferral) {
                // Increment user's referral count
                this.userReferralCount++;
                
                // Update displays with animation
                this.animateCounterUpdate();
                this.updateTierProgress();
                this.refreshStanding();
                this.evaluateAmbassadorReward();
                
                // Check if user unlocked a new tier
                this.checkTierUnlock();
                
                // Show celebration
                this.showReferralCelebration(newReferral.email);
            }
            
            checkTierUnlock() {
                const newlyUnlockedTiers = this.tiers.filter(tier => 
                    tier.referralsRequired === this.userReferralCount
                );
                
                newlyUnlockedTiers.forEach(tier => {
                    this.showTierUnlockCelebration(tier);
                });
            }
            
            updateReferralDisplay() {
                const countElement = document.getElementById('live-referral-count');
                if (countElement) {
                    countElement.textContent = this.userReferralCount;
                }
                
                // Update friends joined message
                const friendsMessage = document.getElementById('friends-joined-message');
                if (friendsMessage && this.userReferralCount > 0) {
                    friendsMessage.textContent = `${this.userReferralCount} wellness friend${this.userReferralCount !== 1 ? 's' : ''} jumped in with your link and now chase the journey with you.`;
                    friendsMessage.classList.remove('hidden');
                }
            }
            
            updateTierProgress() {
                this.tiers.forEach(tier => {
                    const progress = Math.min(this.userReferralCount / tier.referralsRequired, 1);
                    const isUnlocked = this.userReferralCount >= tier.referralsRequired;

                    this.updateTierCard(tier, progress, isUnlocked);
                });
            }

            updateTierCard(tier, progress, isUnlocked) {
                const tierElement = document.getElementById(`tier-${tier.id}`);
                if (!tierElement) return;

                const titleElement = tierElement.querySelector('.tier-title');

                if (isUnlocked) {
                    // Tier is unlocked
                    tierElement.classList.remove('tier-locked');
                    tierElement.classList.add('tier-unlocked');
                } else {
                    // Tier is locked
                    tierElement.classList.add('tier-locked');
                    tierElement.classList.remove('tier-unlocked');
                }

                if (titleElement && tier.title) {
                    titleElement.textContent = tier.title;
                }

                const descriptionElement = tierElement.querySelector('.tier-description');
                if (descriptionElement && tier.description) {
                    // Use shortened versions for the new design
                    const shortDescriptions = {
                        1: "1 friend away",
                        2: "3 friends to unlock",
                        3: "5 friends to unlock"
                    };
                    descriptionElement.textContent = shortDescriptions[tier.id] || tier.description;
                }

                // Update progress count display
                const progressCount = document.getElementById(`progress-count-${tier.id}`);
                if (progressCount) {
                    const current = Math.min(this.userReferralCount, tier.referralsRequired);
                    progressCount.textContent = `${current}/${tier.referralsRequired}`;
                }

                this.updateProgressBar(tier, progress, isUnlocked);
            }
            
            updateProgressBar(tier, progress, isUnlocked) {
                const progressBar = document.getElementById(`progress-bar-${tier.id}`);
                if (progressBar) {
                    const progressFill = progressBar.querySelector('.progress-fill');
                    if (progressFill) {
                        const percentage = Math.round(progress * 100);
                        progressFill.style.width = `${percentage}%`;
                        progressFill.style.transition = 'width 0.8s ease-out';
                    }
                }

                const progressLabel = document.getElementById(`progress-label-${tier.id}`);
                if (!progressLabel) return;

                if (isUnlocked) {
                    progressLabel.textContent = `‚ú® Unlocked!`;
                    progressLabel.classList.add('text-emerald-600', 'dark:text-emerald-400', 'font-bold');
                    return;
                }

                const remaining = Math.max(tier.referralsRequired - this.userReferralCount, 0);
                if (remaining === 0) {
                    progressLabel.textContent = `Ready to unlock`;
                } else if (remaining === 1) {
                    progressLabel.textContent = `1 friend away`;
                } else {
                    progressLabel.textContent = `${remaining} friends to unlock`;
                }
            }

            computePercentile() {
                if (!this.userWaitlistPosition) {
                    return null;
                }

                const cap = Math.max(Number(this.waitlistCap) || 1, 1);
                const totalMembers = Math.max(Number(this.totalCommunitySize) || 0, 0);
                const position = Math.max(Number(this.userWaitlistPosition) || cap, 1);

                // Use the larger of current cohort size or the cap so early adopters
                // get credit for how early they are relative to the 500-seat limit.
                const denominator = Math.max(cap, totalMembers, position);
                const percentile = 1 - (position / denominator);
                return Math.max(0, Math.min(percentile, 0.9999));
            }

            refreshStanding() {
                this.userPercentile = this.computePercentile();
                this.updateTierStatus();
            }

            updateTierStatus() {
                const nameEl = document.getElementById('waitlist-tier-name');
                const subtitleEl = document.getElementById('waitlist-tier-subtitle');

                if (!nameEl || !subtitleEl) {
                    return;
                }

                // Display the single movement card - no percentile calculation needed
                nameEl.textContent = this.movementCard.title;
                subtitleEl.textContent = this.movementCard.subtitle;

                this.ambassadorRewardActive = this.userReferralCount >= 5;
            }
            
            updateCommunityDisplay() {
                const communitySizeElement = document.getElementById('community-size');
                if (communitySizeElement) {
                    communitySizeElement.textContent = this.totalCommunitySize.toLocaleString();
                }
                
                const dailyReferralsElement = document.getElementById('daily-referrals');
                if (dailyReferralsElement && this.dailyReferrals) {
                    dailyReferralsElement.textContent = this.dailyReferrals;
                    dailyReferralsElement.parentElement.classList.remove('hidden');
                }
            }

            evaluateAmbassadorReward() {
                const card = document.getElementById('ambassador-card');
                const message = document.getElementById('ambassador-message');

                if (!card || !message) {
                    return;
                }

                if (this.totalCommunitySize < this.waitlistCap) {
                    card.classList.add('hidden');
                    card.classList.remove('ambassador-locked');
                    return;
                }

                const hasAmbassadorStatus = this.userReferralCount >= 5;

                card.classList.remove('hidden');
                card.classList.toggle('ambassador-locked', !hasAmbassadorStatus);

                if (!hasAmbassadorStatus) {
                    message.textContent = 'Cohort 1 is almost sealed. Refer five friends to earn three free months and bring one more local in with you.';
                } else if (this.ambassadorRewardActive) {
                    message.textContent = "We're at capacity &mdash; three free months are locked. Watch your inbox for Ambassador invitations.";
                } else {
                    message.textContent = 'One more referral cements your Ambassador invite‚Äîyour free months are already locked.';
                }
            }
            
            animateCounterUpdate() {
                const countElement = document.getElementById('live-referral-count');
                if (countElement) {
                    // Add pulse animation
                    countElement.classList.add('animate-pulse-success');
                    setTimeout(() => {
                        countElement.classList.remove('animate-pulse-success');
                    }, 1000);
                }
            }
            
            showReferralCelebration(referralEmail) {
                // Create celebration notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 animate-slide-in-right';
                notification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <div class="font-bold">New referral!</div>
                            <div class="text-sm opacity-90">Someone just joined through your link</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    notification.classList.add('animate-slide-out-right');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
                
                // Trigger confetti
                this.launchMiniConfetti();
            }
            
            showTierUnlockCelebration(tier) {
                // Create tier unlock modal/celebration
                const celebration = document.createElement('div');
                celebration.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in';
                celebration.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-md mx-4 text-center animate-scale-in">
                        <div class="w-20 h-20 bg-gradient-to-br from-amber-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-4 tier-unlock-glow">
                            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Tier Unlocked!</h3>
                        <h4 class="text-xl font-semibold text-amber-600 dark:text-amber-400 mb-2">${tier.title}</h4>
                        <p class="text-gray-600 dark:text-gray-300 mb-6">${tier.reward}</p>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-white font-bold py-3 px-6 rounded-lg transition-colors" style="background: linear-gradient(90deg,#f59e0b,#ea580c)">
                            Awesome!
                        </button>
                    </div>
                `;
                
                document.body.appendChild(celebration);
                
                // Launch celebration confetti
                this.launchCelebrationConfetti();
            }
            
            launchMiniConfetti() {
                // Mini confetti burst for referral notifications
                this.createConfetti(50, 1500);
            }
            
            launchCelebrationConfetti() {
                // Big confetti burst for tier unlocks
                this.createConfetti(200, 3000);
            }
            
            createConfetti(particleCount, duration) {
                const canvas = document.getElementById('confetti-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                const confetti = [];
                const colors = ['#10b981', '#059669', '#0d9488', '#0891b2', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16'];
                
                for (let i = 0; i < particleCount; i++) {
                    confetti.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height - canvas.height,
                        w: Math.random() * 12 + 4,
                        h: Math.random() * 8 + 2,
                        vx: (Math.random() - 0.5) * 6,
                        vy: Math.random() * 4 + 3,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        angle: Math.random() * 360,
                        rotationSpeed: (Math.random() - 0.5) * 10,
                        opacity: Math.random() * 0.8 + 0.2,
                        shape: Math.random() > 0.5 ? 'rect' : 'circle'
                    });
                }
                
                const startTime = Date.now();
                
                function animate() {
                    const elapsed = Date.now() - startTime;
                    if (elapsed > duration) return;
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    confetti.forEach((c, index) => {
                        c.y += c.vy;
                        c.x += c.vx;
                        c.angle += c.rotationSpeed;
                        c.vy += 0.2; // gravity
                        
                        ctx.save();
                        ctx.globalAlpha = c.opacity;
                        ctx.translate(c.x, c.y);
                        ctx.rotate(c.angle * Math.PI / 180);
                        ctx.fillStyle = c.color;
                        
                        if (c.shape === 'circle') {
                            ctx.beginPath();
                            ctx.arc(0, 0, c.w / 2, 0, Math.PI * 2);
                            ctx.fill();
                        } else {
                            ctx.fillRect(-c.w / 2, -c.h / 2, c.w, c.h);
                        }
                        
                        ctx.restore();
                        
                        if (c.y > canvas.height + 100) {
                            confetti.splice(index, 1);
                        }
                    });
                    
                    if (confetti.length > 0) {
                        requestAnimationFrame(animate);
                    }
                }
                
                animate();
            }
            
            startPeriodicUpdates() {
                // Update community stats every 30 seconds
                setInterval(async () => {
                    await this.loadCommunityStats();
                }, 30000);
                
                // Update user stats every 60 seconds
                setInterval(async () => {
                    await this.loadUserStats();
                }, 60000);
            }
            
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-20 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => errorDiv.remove(), 5000);
            }
            
            destroy() {
                if (this.realTimeSubscription) {
                    this.realTimeSubscription.unsubscribe();
                }
            }
        }

        // CRITICAL: Guard against false positives - verify user actually submitted form
        (function validateSuccessPage() {
            const email = sessionStorage.getItem('waitlist_email');
            const referralCode = sessionStorage.getItem('waitlist_referral_code');
            const timestamp = sessionStorage.getItem('waitlist_timestamp');
            
            // Check if required data exists
            if (!email || !referralCode || !timestamp) {
                console.error('[SUCCESS GUARD] Missing required session data', {
                    hasEmail: !!email,
                    hasReferralCode: !!referralCode,
                    hasTimestamp: !!timestamp
                });
                // Store error for debugging
                localStorage.setItem('localplate:successError', JSON.stringify({
                    at: Date.now(),
                    error: 'Missing session data',
                    hasEmail: !!email,
                    hasReferralCode: !!referralCode,
                    hasTimestamp: !!timestamp
                }));
                // Redirect to home
                window.location.replace('index.html');
                return;
            }
            
            // Validate timestamp is recent (within 60 seconds)
            const submittedAt = parseInt(timestamp, 10);
            const now = Date.now();
            const ageMs = now - submittedAt;
            
            if (isNaN(submittedAt) || ageMs > 60000 || ageMs < 0) {
                console.error('[SUCCESS GUARD] Invalid or expired timestamp', {
                    timestamp,
                    ageMs,
                    maxAge: 60000
                });
                // Store error for debugging
                localStorage.setItem('localplate:successError', JSON.stringify({
                    at: now,
                    error: 'Expired or invalid timestamp',
                    ageMs,
                    timestamp
                }));
                // Clear stale data
                sessionStorage.removeItem('waitlist_email');
                sessionStorage.removeItem('waitlist_referral_code');
                sessionStorage.removeItem('waitlist_timestamp');
                sessionStorage.removeItem('waitlist_inserted_id');
                // Redirect to home
                window.location.replace('index.html');
                return;
            }
            
            console.log('[SUCCESS GUARD] Validation passed', {
                email,
                referralCode,
                ageMs: ageMs + 'ms'
            });
        })();
        
        // Initialize Supabase client when needed
        window.getSupabaseClient = function() {
            if (DEBUG) console.log('[getSupabaseClient] called');
            
            try {
                // Check if supabase library is loaded
                if (!window.supabase || typeof window.supabase.createClient !== 'function') {
                    throw new Error('Supabase library not loaded. Please check your internet connection and try refreshing the page.');
                }
                
                // Assert config is loaded
                if (!window.LOCALPLATE_CONFIG) {
                    throw new Error('Configuration not loaded. Please refresh the page and try again.');
                }
                
                // Get configuration from config.js
                const SUPABASE_URL = window.LOCALPLATE_CONFIG?.supabase?.url || 'YOUR_SUPABASE_URL';
                const SUPABASE_ANON_KEY = window.LOCALPLATE_CONFIG?.supabase?.anonKey || 'YOUR_SUPABASE_ANON_KEY';
                
                // Validate credentials
                if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || !SUPABASE_URL) {
                    throw new Error('Supabase URL not configured properly');
                }
                if (SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY' || !SUPABASE_ANON_KEY) {
                    throw new Error('Supabase API key not configured properly');
                }
                
                // Validate URL format
                if (!SUPABASE_URL.startsWith('https://') || !SUPABASE_URL.includes('supabase.co')) {
                    throw new Error('Invalid Supabase URL format');
                }
                
                if (DEBUG) console.log('[getSupabaseClient] Creating client...');
                
                // Create client
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                if (!client) {
                    throw new Error('Failed to create Supabase client');
                }
                
                if (DEBUG) console.log('[getSupabaseClient] Client created successfully');
                return client;
                
            } catch (error) {
                console.error('Failed to initialize Supabase client:', error.message);
                throw new Error(`Database connection failed: ${error.message}`);
            }
        }
        
        // Update page with user data
        if (cachedReferralCode) {
            const referralLink = `${window.location.origin}/?ref=${cachedReferralCode}`;
            document.getElementById('referral-link').value = referralLink;
        }
        
        logTelemetry('success_page_view');
        trackEvent('success_page_view', {});

        // Confetti animation
        function launchConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const confetti = [];
            const colors = ['#10b981', '#059669', '#0d9488', '#0891b2', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16'];
            
            for (let i = 0; i < 200; i++) {
                confetti.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    w: Math.random() * 12 + 4,
                    h: Math.random() * 8 + 2,
                    vx: (Math.random() - 0.5) * 4,
                    vy: Math.random() * 4 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    angle: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 8,
                    opacity: Math.random() * 0.8 + 0.2,
                    shape: Math.random() > 0.5 ? 'rect' : 'circle'
                });
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                confetti.forEach((c, index) => {
                    c.y += c.vy;
                    c.x += c.vx;
                    c.angle += c.rotationSpeed;
                    c.vy += 0.1; // gravity
                    
                    ctx.save();
                    ctx.globalAlpha = c.opacity;
                    ctx.translate(c.x, c.y);
                    ctx.rotate(c.angle * Math.PI / 180);
                    ctx.fillStyle = c.color;
                    
                    if (c.shape === 'circle') {
                        ctx.beginPath();
                        ctx.arc(0, 0, c.w / 2, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        ctx.fillRect(-c.w / 2, -c.h / 2, c.w, c.h);
                    }
                    
                    ctx.restore();
                    
                    if (c.y > canvas.height + 100) {
                        confetti.splice(index, 1);
                    }
                });
                
                if (confetti.length > 0) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }
        
        // Launch confetti on load
        setTimeout(launchConfetti, 500);
        
        // Enhanced copy link function with better feedback
        function copyLink(ev) {
            const input = document.getElementById('referral-link');
            const buttonCandidate = ev?.currentTarget || ev?.target || document.getElementById('share-copy');
            const button = buttonCandidate instanceof HTMLElement ? buttonCandidate : null;
            
            // Modern clipboard API with fallback
            const copyText = async () => {
                if (navigator.clipboard) {
                    try {
                        await navigator.clipboard.writeText(input.value);
                        return true;
                    } catch (err) {
                        console.warn('Clipboard API failed, falling back to execCommand');
                    }
                }
                
                // Fallback for older browsers
                input.select();
                input.setSelectionRange(0, 99999); // For mobile devices
                return document.execCommand('copy');
            };
            
            copyText().then(success => {
                if (success) {
                    // Button feedback
                    const originalText = button ? button.innerHTML : '';
                    if (button) {
                        button.innerHTML = `
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Copied!
                    `;
                        button.classList.add('copy-success');
                    }
                    
                    // Show toast
                    const toast = document.getElementById('copy-toast');
                    if (toast) {
                        toast.classList.remove('hidden');
                    }
                    
                    // Reset after delay
                    setTimeout(() => {
                        if (button) {
                            button.innerHTML = originalText;
                            button.classList.remove('copy-success');
                        }
                        if (toast) {
                            toast.classList.add('hidden');
                        }
                    }, 3000);
                    
                    logTelemetry('share_clicked', { channel: 'copy_link' });
                    trackEvent('share_clicked', { channel: 'copy_link' });
                } else {
                    // Show error feedback
                    console.error('Failed to copy to clipboard');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-20 right-4 bg-red-500 text-white px-4 py-2 rounded-lg z-50';
                    errorDiv.textContent = 'Failed to copy link';
                    document.body.appendChild(errorDiv);
                    setTimeout(() => errorDiv.remove(), 3000);
                }
            });
        }
        
        // Share functions for all platforms with telemetry
        (function initializeShareButtons() {
            const referralInput = document.getElementById('referral-link');
            if (!referralInput) return;

            const url = referralInput.value;
            const text = "I just locked a wellness head start in LocalPlate's 500-seat founding cohort‚Äîuse my link to skip the wait with me:";

            const enc = encodeURIComponent;
            const encodedUrl = enc(url);
            const encodedText = enc(text);

            const shareTargets = [
                { id: 'share-x', href: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedText}`, channel: 'x' },
                { id: 'share-facebook', href: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`, channel: 'facebook' },
                { id: 'share-linkedin', href: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`, channel: 'linkedin' },
                { id: 'share-whatsapp', href: `https://wa.me/?text=${encodedText}%20${encodedUrl}`, channel: 'whatsapp' },
                { id: 'share-bluesky', href: `https://bsky.app/intent/compose?text=${encodedText}%20${encodedUrl}`, channel: 'bluesky' }
            ];

            shareTargets.forEach(({ id, href, channel }) => {
                const el = document.getElementById(id);
                if (el) {
                    el.setAttribute('href', href);
                    el.addEventListener('click', () => {
                        logTelemetry('share_clicked', { channel });
                        trackEvent('share_clicked', { channel });
                    });
                }
            });

            const copyBtn = document.getElementById('share-copy');
            if (copyBtn) {
                copyBtn.addEventListener('click', (evt) => {
                    copyLink(evt);
                });
            }
        })();
        // Dark mode toggle functionality - Enhanced version matching waitlist.js
        function initDarkMode() {
            try {
                const html = document.documentElement;
                const themeToggle = document.getElementById('theme-toggle');

                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const currentTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

                if (currentTheme === 'dark') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }

                if (themeToggle) {
                    const handleToggle = () => {
                        try {
                            if (html.classList.contains('dark')) {
                                html.classList.remove('dark');
                                localStorage.setItem('theme', 'light');
                                console.log('[DarkMode] Switched to light mode');
                            } else {
                                html.classList.add('dark');
                                localStorage.setItem('theme', 'dark');
                                console.log('[DarkMode] Switched to dark mode');
                            }
                        } catch (error) {
                            console.error('[DarkMode] Error toggling theme:', error);
                        }
                    };

                    themeToggle.addEventListener('click', handleToggle);
                    themeToggle.dataset.darkModeInitialized = 'true';
                } else {
                    console.warn('[DarkMode] Theme toggle button not found; applied stored theme only');
                }

                console.log('[DarkMode] Initialized successfully with theme:', currentTheme);

            } catch (error) {
                console.error('[DarkMode] Initialization failed:', error);
                try {
                    if (localStorage.getItem('theme') === 'dark') {
                        document.documentElement.classList.add('dark');
                    }
                } catch (fallbackError) {
                    console.error('[DarkMode] Fallback initialization failed:', fallbackError);
                }
            }
        }
        
        // Initialize dark mode early to prevent FOUC
        initDarkMode();

        // Additional initialization after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Scroll reveal for parity with main pages
            (function initScrollReveal(){
                try {
                    const isMobile = window.innerWidth <= 768;
                    const observer = new IntersectionObserver((entries, obs) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('revealed');
                                obs.unobserve(entry.target);
                            }
                        });
                    }, {
                        threshold: isMobile ? [0.1, 0.3] : [0.1, 0.3, 0.5],
                        rootMargin: isMobile ? '0px 0px -50px 0px' : '0px 0px -100px 0px'
                    });
                    document.querySelectorAll('.reveal-on-scroll').forEach(el => observer.observe(el));
                } catch (err) {
                    console.warn('[reveal] init failed:', err);
                }
            })();
            // Ensure dark mode is still properly initialized after DOM is ready
            const toggleEl = document.getElementById('theme-toggle');
            if (toggleEl && !toggleEl.dataset.darkModeInitialized) {
                console.log('[DarkMode] Re-initializing after DOM ready');
                initDarkMode();
            }
        });
        
        // Debug function for testing dark mode functionality
        window.testDarkMode = function() {
            console.log('=== DARK MODE DEBUG TEST ===');
            
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            const currentTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const hasDarkClass = html.classList.contains('dark');
            
            console.log('Theme toggle button:', themeToggle ? '‚úì Found' : '‚úó Missing');
            console.log('Current theme setting:', currentTheme || 'None (using system preference)');
            console.log('System prefers dark:', systemPrefersDark);
            console.log('HTML has dark class:', hasDarkClass);
            console.log('Event listeners attached:', !!themeToggle?.onclick || themeToggle?.addEventListener ? '‚úì Yes' : '‚úó No');
            
            // Test toggle functionality
            if (themeToggle) {
                console.log('Testing toggle...');
                const beforeToggle = html.classList.contains('dark');
                themeToggle.click();
                const afterToggle = html.classList.contains('dark');
                console.log('Toggle test:', beforeToggle !== afterToggle ? '‚úì Working' : '‚úó Failed');
                
                // Restore original state
                themeToggle.click();
                console.log('State restored');
            }
            
            console.log('=== TEST COMPLETE ===');
        };
        
        // Initialize gamification system
        window.gamificationSystem = new ReferralGamificationSystem();
        
        // Start gamification system after page is ready
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[GAMIFICATION] Starting initialization...');
            
            try {
                // Add loading states while initializing
                const loadingElements = document.querySelectorAll('#community-size, #live-referral-count');
                loadingElements.forEach(el => {
                    if (el) {
                        el.classList.add('loading-pulse');
                        el.textContent = 'Loading...';
                    }
                });
                
                // Initialize the system
                await window.gamificationSystem.init();
                
                // Remove loading states
                loadingElements.forEach(el => {
                    if (el) {
                        el.classList.remove('loading-pulse');
                    }
                });
                
                console.log('[GAMIFICATION] System ready!');
            } catch (error) {
                console.error('[GAMIFICATION] Failed to initialize:', error);
                
                // Remove loading states and show fallback
                const loadingElements = document.querySelectorAll('#community-size, #live-referral-count');
                loadingElements.forEach(el => {
                    if (el) {
                        el.classList.remove('loading-pulse');
                        if (el.id === 'community-size') el.textContent = '1000+';
                        if (el.id === 'live-referral-count') el.textContent = '0';
                    }
                });
                
                // Hide social proof if data loading failed
                const socialProof = document.getElementById('social-proof');
                if (socialProof) socialProof.classList.add('hidden');
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.gamificationSystem) {
                window.gamificationSystem.destroy();
            }
        });
    </script>
</body>
</html>
